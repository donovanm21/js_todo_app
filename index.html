<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="description" content="Javascript ToDo Application" >
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="includes/js/scripts.js"></script>
        <link rel="stylesheet" href="includes/css/styles.css" >
        <title>My Javascript | ToDo App</title>
    </head>
    <body>
        <div class="wrapper">
            <div class="content">
                <!-- Header Section -->
                <div class="header">
                    <header>
                        <h1>Simple JS | ToDo App</h1>
                        <p id="greeting" style="text-align: center;"></p>
                    </header>
                </div>
                <!-- Category Section -->
                <div class="categories">
                    <h2>Categories</h2>
                    <div class="grid-container" id="category-grid"></div>
                </div>
                <!-- Task Section -->
                <div class="task-list">
                    <h2 class="center">ToDo List</h2>
                    <div class="task-wrapper" id="task-wrapper">
                    </div>
                </div>
                <!-- Task Button for adding tasks -->
                <div class="add-task" onclick="alert('New Task');">
                    <div class="add-button">+</div>
                    <div class="clear"></div>
                </div>
                
                <!-- Add new task section -->
                <div class="add-task-section">
                    <h2>Add New Task</h2>
                    <div class="add-task-form">
                        <form id="new-task-form" action="#" method="POST">
                            <label class="task-label">Title</label>
                                <input class="task-input" id="new-task-title" type="text" placeholder="House Work"/>
                            <label class="task-label">Description</label>
                                <textarea class="task-input" id="new-task-description" placeholder="Task Description"></textarea>
                            <label class="task-label">Date Due</label>
                                <input class="task-input" id="new-task-date-due" type="date" />
                            <label class="task-label">Time Due</label>
                                <input class="task-input" id="new-task-time-due" type="time" />
                            <label class="task-label">Priority</label>
                                <input id="new-task-slider" class="task-input" type="range" min="1" max="3" />
                                <div id="new-task-priority"></div>
                            <label class="task-label">Categories</label>
                                <!-- Find a style that creates selectable buttons -->
                                <div class="new-task-categories" id="new-task-categories">
                                </div>
                                <!-- Function will grab this input if not empty to create a new category -->
                                <input class="task-input new-category" id="new-task-category" type="text" placeholder="New Category"/>
                            <input class="submit" type="submit" name="" onclick="addNewTask();" value="Create"/>
                        </form>
                    </div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>

                <!-- Task preview section -->
                <div class="task-preview-section">
                    <h2>Task Preview</h2>
                    <div class="task-preview-form">
                        <form id="task-preview-form" action="#" method="POST">
                            <input type="hidden" id="task-preview-taskkey" />
                            <label class="task-label">Title</label>
                                <input class="task-input" id="task-preview-title" type="text" placeholder="House Work"/>
                            <label class="task-label">Description</label>
                                <textarea class="task-input" id="task-preview-description" placeholder="Task Description" value=""></textarea>
                            <label class="task-label">Date Due</label>
                                <input class="task-input" id="task-preview-date-due" type="date" value=""/>
                            <label class="task-label">Time Due</label>
                                <input class="task-input" id="task-preview-time-due" type="time" value=""/>
                            <label class="task-label">Priority</label>
                                <input id="task-preview-slider" class="task-input" type="range" min="1" max="3" value=""/>
                                <div id="task-preview-priority"></div>
                            <label class="task-label">Categories</label>
                                <!-- Find a style that creates selectable buttons -->
                                <div class="task-preview-categories" id="task-preview-categories">
                                </div>
                                <!-- Function will grab this input if not empty to create a new category -->
                                <input class="task-input new-category" id="task-preview-category" type="text" placeholder="New Category"/>
                            <input class="submit" type="submit" name="" onclick="updateTask('u');" value="Update"/>
                            <input class="submit" type="submit" name="" onclick="updateTask('c');" value="Complete"/>
                            <input class="submit hidden" id="task-delete" type="submit" name="" onclick="updateTask('d');" value="Delete"/>
                        </form>
                    </div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
            </div>
            <div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
        <!-- Footer Section -->
        <footer></footer>
    </body>
    <script>
        // Initialization of the app on first load
        appInit();
        // Category loader for existing categories
        catLoad();
        // Get all existing tasks
        getTasks();
        // Categories selection for new tasks
        getCategories('n','new-task-categories');
        // Categories selection for preview of existing tasks
        getCategories('p','task-preview-categories');
        // Slider for new tasks
        sliderDisplay('new-task-slider', 'new-task-priority');
        // Slider for task preview and update
        sliderDisplay('task-preview-slider', 'task-preview-priority');

        // Range Slider showing priority level.
        function sliderDisplay(sliderID, priorityID) {
            let slider = document.getElementById(sliderID);
            let priority = document.getElementById(priorityID);
            if(slider.value == 2){
                priority.innerHTML = '<textarea style="color: orange; display: none;" id="'+priorityID+'-ta">Medium</textarea>';
                priority.innerHTML += '<p style="color: orange;">Medium</p>';
            }
            // Update priority output on slider value change.
            slider.oninput = function() {
                if(slider.value == 1){
                priority.innerHTML = '<textarea style="color: lightblue; display: none;" id="'+priorityID+'-ta">Low</textarea>';
                priority.innerHTML += '<p style="color: lightblue;">Low</p>';
                } else if(slider.value == 2) {
                    priority.innerHTML = '<textarea style="color: orange; display: none;" id="'+priorityID+'-ta">Medium</textarea>';
                    priority.innerHTML += '<p style="color: orange;">Medium</p>';
                } else {
                    priority.innerHTML = '<textarea style="color: red; display: none;" id="'+priorityID+'-ta">High</textarea>';
                    priority.innerHTML += '<p style="color: red;">High</p>';
                }
            }
        }
        
        // Form Action
        //document.getElementById('new-task-form').addEventListener('click', function(event){
        //    event.preventDefault();
        //    let taskPriority = document.getElementById('new-task-priority').value;
        //});

        // Add new task
        function addNewTask() {
            let taskTitle = document.getElementById('new-task-title').value;
            let catArray = new Category('tempArr');
            if(taskTitle != "") {
                let taskTitle = document.getElementById('new-task-title').value;
                let taskDescription = document.getElementById('new-task-description').value;
                let taskDateDue = document.getElementById('new-task-date-due').value;
                let taskTimeDue = document.getElementById('new-task-time-due').value;
                let taskPriority = document.getElementById('new-task-priority-ta').value;
                let taskTags = [];
                for(i = 0; i < catArray.catArr.length; i++) {
                    let nCatSelected = document.getElementById('n-c'+i+'');
                    if(nCatSelected.checked !== false) {
                        let tempCat = document.getElementById('n-c'+i+'').value;
                        taskTags.push(tempCat);
                    }
                    let pCatSelected = document.getElementById('p-c'+i+'');
                    if(pCatSelected.checked !== false) {
                        let tempCat = document.getElementById('p-c'+i+'').value;
                        taskTags.push(tempCat);
                    }
                }
                let tempNewCategory = document.getElementById('new-task-category').value;
                if(tempNewCategory != "") {
                    taskTags.push(tempNewCategory);
                }
                let tempNewTask = new Task(taskTitle, taskDescription, taskDateDue, taskTimeDue, taskPriority, taskTags, false);
                tempNewTask.addTask();
                newTaskCategory();
            } else {
                console.log('Error: Please fill in all the fields');
            }
        }

        // Get all existing task from storage
        function getTasks() {
            let taskArray = taskArr();
            let taskKeysArray = taskKeys();
            for(i = 0; i < taskArray.length; i++) {
                document.getElementById('task-wrapper').innerHTML += '<a id="'+i+'" onclick="fetchTask(this.id);"><div class="task-item" id="task-item'+i+'"></div></a>';
                document.getElementById('task-item'+i+'').innerHTML += '<div name="task-key" class="task-key"><textarea id="task-key'+i+'">'+ taskKeysArray[i] +'</textarea></div>';
                document.getElementById('task-item'+i+'').innerHTML += '<div class="task-text">'+ taskArray[i]['title'] +'</div>';
                if(taskArray[i]['priority'] == "High") {
                    for(n = 0; n < taskArray[i]['tags'].length; n++) {
                        document.getElementById('task-item'+i+'').innerHTML += '<div class="icon-category icon-priority-high">'+ taskArray[i]['tags'][n][0] +'</div>';
                    }
                } else if(taskArray[i]['priority'] == "Medium") {
                    for(n = 0; n < taskArray[i]['tags'].length; n++) {
                        document.getElementById('task-item'+i+'').innerHTML += '<div class="icon-category icon-priority-medium">'+ taskArray[i]['tags'][n][0] +'</div>';
                    }
                } else {
                    for(n = 0; n < taskArray[i]['tags'].length; n++) {
                        document.getElementById('task-item'+i+'').innerHTML += '<div class="icon-category icon-priority-low">'+ taskArray[i]['tags'][n][0] +'</div>';
                    }
                }
                document.getElementById('task-item'+i+'').innerHTML += '<div class="clear"></div>';
                let taskCompleted = taskArray[i]['completed'];
                if(taskCompleted == true) {
                    let newClass = document.getElementById('task-item'+i);
                    newClass.classList.add('task-completed');
                }
            }
        }

        // Fetch task info and display it in preview
        function fetchTask(clickedId) {
            const taskArrKey = taskArr();
            let taskKey = 'task'+clickedId;
            let taskTitle = taskArrKey[clickedId]['title'];
            let taskDescription = taskArrKey[clickedId]['description'];
            let taskDateDue = taskArrKey[clickedId]['date_due'];
            let taskTimeDue = taskArrKey[clickedId]['time_due'];
            let taskPriority = taskArrKey[clickedId]['priority'];
            let taskTags = taskArrKey[clickedId]['tags'];
            document.getElementById('task-preview-taskkey').value = taskKey;
            document.getElementById('task-preview-title').value = taskTitle;
            document.getElementById('task-preview-description').value = taskDescription;
            document.getElementById('task-preview-date-due').value = taskDateDue;
            document.getElementById('task-preview-time-due').value = taskTimeDue;
            let taskCompleted = taskArrKey[clickedId]['completed'];
            if(taskCompleted == true) {
                let taskDelete = document.getElementById('task-delete');
                taskDelete.classList.add('not-hidden');
            }
        }
        
        // Update task info
        function updateTask(value) {
            let taskTitle = document.getElementById('task-preview-title').value;
            let catArray = new Category('tempArr');
            if(taskTitle != "") {
                let taskKey = document.getElementById('task-preview-taskkey').value;
                let taskTitle = document.getElementById('task-preview-title').value;
                let taskDescription = document.getElementById('task-preview-description').value;
                let taskDateDue = document.getElementById('task-preview-date-due').value;
                let taskTimeDue = document.getElementById('task-preview-time-due').value;
                let taskPriority = document.getElementById('task-preview-priority-ta').value;
                let taskTags = [];
                for(i = 0; i < catArray.catArr.length; i++) {
                    let nCatSelected = document.getElementById('n-c'+i+'');
                    if(nCatSelected.checked !== false) {
                        let tempCat = document.getElementById('n-c'+i+'').value;
                        taskTags.push(tempCat);
                    }
                    let pCatSelected = document.getElementById('p-c'+i+'');
                    if(pCatSelected.checked !== false) {
                        let tempCat = document.getElementById('p-c'+i+'').value;
                        taskTags.push(tempCat);
                    }
                }
                let tempNewCategory = document.getElementById('task-preview-category').value;
                if(tempNewCategory != "") {
                    taskTags.push(tempNewCategory);
                }
                let localData = getLocalData();
                if(value == 'u') {
                    localData['todo_data'][taskKey]['title'] = taskTitle;
                    localData['todo_data'][taskKey]['description'] = taskDescription;
                    localData['todo_data'][taskKey]['date_due'] = taskDateDue;
                    localData['todo_data'][taskKey]['time_due'] = taskTimeDue;  
                    localData['todo_data'][taskKey]['priority'] = taskPriority;
                    localData['todo_data'][taskKey]['tags'] = taskTags;
                } else if(value == 'c'){
                    localData['todo_data'][taskKey]['completed'] = true;
                } else if(value == 'd'){
                    let taskObj = localData['todo_data'];
                    delete taskObj[taskKey];
                } else {
                    console.log('Task Update');
                }
                parseData(localData);
                // Add new Category if one is specified
                newTaskCategory();
            } else {
                console.log('Error: Please fill in all the fields');
            }
        }
    </script>
</html>